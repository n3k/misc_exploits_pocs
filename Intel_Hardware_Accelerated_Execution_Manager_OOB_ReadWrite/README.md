# CVE-2017-5683 - Intel Hardware Accelerated Execution Manager (IntelHaxm.sys) out of bounds read-write IOCTL

* Affected driver: IntelHaxm.sys <= 6.0.1.0

Update: https://security-center.intel.com/advisory.aspx?intelid=INTEL-SA-00072&languageid=en-fr
 
+] Summary: There is an out of bounds array write condition in IntelHaxm.sys which could allow attackers to get SYSTEM privileges in the affected machine.

+] Description: Intel Hardware Accelerated Execution Manager (Intel HAXM) is a hardware-assisted virtualization engine (hypervisor) that uses Intel Virtualization Technology (Intel VT) to speed up Android* app emulation on a host machine. In combination with Android x86 emulator images provided by Intel and the official Android SDK Manager, Intel HAXM allows for faster Android emulation on Intel VT enabled systems.
More into at: https://software.intel.com/en-us/android/articles/intel-hardware-accelerated-execution-manager

This driver is deployed as part of AndroidStudio (https://developer.android.com/studio/index.html?hl=en). It can also be installed manually.

+] Technical Description: 

The bug could be triggered by issuing the IOCTL 0x40002430 to a hax_vmXX_vcpuXX device. Such device can be created through other IOCTLs that the same driver expose.



* Disassembly of the vuln code:

```
IntelHaxm+0xa26c:
fffff80d`370ea26c 4883ec28        sub     rsp,28h
fffff80d`370ea270 4c8bc1          mov     r8,rcx
fffff80d`370ea273 8bc2            mov     eax,edx  --> EDX Controlled
fffff80d`370ea275 8bca            mov     ecx,edx
fffff80d`370ea277 c1e805          shr     eax,5
fffff80d`370ea27a 83e11f          and     ecx,1Fh
fffff80d`370ea27d 41b901000000    mov     r9d,1
fffff80d`370ea283 448bd0          mov     r10d,eax
fffff80d`370ea286 418b848030030000 mov     eax,dword ptr [r8+rax*4+330h] --> Out of Bounds read
fffff80d`370ea28e 41d3e1          shl     r9d,cl
fffff80d`370ea291 4185c1          test    r9d,eax
fffff80d`370ea294 740e            je      IntelHaxm+0xa2a4 (fffff80d`370ea2a4)   --------|
fffff80d`370ea296 488d0db35f0000  lea     rcx,[IntelHaxm+0x10250 (fffff80d`370f0250)]    |
fffff80d`370ea29d e83285ffff      call    IntelHaxm+0x27d4 (fffff80d`370e27d4)			 |
fffff80d`370ea2a2 eb12            jmp     IntelHaxm+0xa2b6 (fffff80d`370ea2b6)			 |
fffff80d`370ea2a4 410bc1          or      eax,r9d     <----------------------------------|
fffff80d`370ea2a7 4389849030030000 mov     dword ptr [r8+r10*4+330h],eax  --> out of bounds Write
fffff80d`370ea2af 41ff8050030000  inc     dword ptr [r8+350h]
fffff80d`370ea2b6 4883c428        add     rsp,28h
fffff80d`370ea2ba c3              ret
```

* Crashdump:

```
nt!DbgBreakPointWithStatus:
fffff801`a19c9d90 cc              int     3
1: kd> !analyze -v
*******************************************************************************
*                                                                             *
*                        Bugcheck Analysis                                    *
*                                                                             *
*******************************************************************************

PAGE_FAULT_IN_NONPAGED_AREA (50)
Invalid system memory was referenced.  This cannot be protected by try-except.
Typically the address is just plain bad or it is pointing at freed memory.
Arguments:
Arg1: ffffbd0071812a9c, memory referenced.
Arg2: 0000000000000000, value 0 = read operation, 1 = write operation.
Arg3: fffff80d370ea286, If non-zero, the instruction address which referenced the bad memory
        address.
Arg4: 0000000000000002, (reserved)

Debugging Details:
------------------


DUMP_CLASS: 1

DUMP_QUALIFIER: 0

BUILD_VERSION_STRING:  14393.321.amd64fre.rs1_release_inmarket.161004-2338

DUMP_TYPE:  0

BUGCHECK_P1: ffffbd0071812a9c

BUGCHECK_P2: 0

BUGCHECK_P3: fffff80d370ea286

BUGCHECK_P4: 2

READ_ADDRESS:  ffffbd0071812a9c

FAULTING_IP:
IntelHaxm+a286
fffff80d`370ea286 418b848030030000 mov     eax,dword ptr [r8+rax*4+330h]

MM_INTERNAL_CODE:  2

DEBUG_FLR_IMAGE_TIMESTAMP:  0

FAULTING_MODULE: fffff80d370e0000 IntelHaxm

CPU_COUNT: 4

CPU_MHZ: a20

CPU_VENDOR:  GenuineIntel

CPU_FAMILY: 6

CPU_MODEL: 5e

CPU_STEPPING: 3

CPU_MICROCODE: 6,5e,3,0 (F,M,S,R)  SIG: 33'00000000 (cache) 33'00000000 (init)

DEFAULT_BUCKET_ID:  CODE_CORRUPTION

BUGCHECK_STR:  AV

PROCESS_NAME:  TestDrivers.ex

CURRENT_IRQL:  0

ANALYSIS_SESSION_HOST:  XXXX-MACHINE1

ANALYSIS_SESSION_TIME:  10-14-2016 16:09:41.0074

ANALYSIS_VERSION: 10.0.10586.567 x86fre

TRAP_FRAME:  ffffa701a927e5a0 -- (.trap 0xffffa701a927e5a0)
NOTE: The trap frame does not contain all registers.
Some register values may be zeroed or incorrect.
rax=0000000007ffffff rbx=0000000000000000 rcx=000000000000001f
rdx=00000000ffffffff rsi=0000000000000000 rdi=0000000000000000
rip=fffff80d370ea286 rsp=ffffa701a927e730 rbp=ffffbd0051812770
 r8=ffffbd0051812770  r9=0000000000000001 r10=0000000007ffffff
r11=7ffffffffffffffc r12=0000000000000000 r13=0000000000000000
r14=0000000000000000 r15=0000000000000000
iopl=0         nv up ei pl nz na pe nc
IntelHaxm+0xa286:
fffff80d`370ea286 418b848030030000 mov     eax,dword ptr [r8+rax*4+330h] ds:ffffbd00`71812a9c=????????
Resetting default scope

LAST_CONTROL_TRANSFER:  from fffff801a1a4d9c6 to fffff801a19c9d90

STACK_TEXT:
ffffa701`a927daf8 fffff801`a1a4d9c6 : ffffbd00`71812a9c 00000000`00000050 ffffa701`a927dc60 fffff801`a194729c : nt!DbgBreakPointWithStatus
ffffa701`a927db00 fffff801`a1a4d3b5 : 00000000`00000003 ffffa701`a927dc60 fffff801`a19d1690 ffffa701`a927e1b0 : nt!KiBugCheckDebugBreak+0x12
ffffa701`a927db60 fffff801`a19c43c4 : 00000000`00000000 fffff801`a19c5d94 00000000`00000000 00000000`00000000 : nt!KeBugCheck2+0x8a5
ffffa701`a927e270 fffff801`a19f96da : 00000000`00000050 ffffbd00`71812a9c 00000000`00000000 ffffa701`a927e5a0 : nt!KeBugCheckEx+0x104
ffffa701`a927e2b0 fffff801`a18eb00a : 00000000`00000000 00000000`00000000 ffffa701`a927e5a0 fffff801`a19cf502 : nt! ?? ::FNODOBFM::`string'+0x2624a
ffffa701`a927e3a0 fffff801`a19cd8fc : 00000000`00000010 00000000`00000246 ffffa701`a927e5c0 fffff801`a19cc6a1 : nt!MmAccessFault+0x9ca
ffffa701`a927e5a0 fffff80d`370ea286 : 00000000`00000010 00000000`00000344 ffffa701`a927e758 00000000`00000018 : nt!KiPageFault+0x13c
ffffa701`a927e730 fffff80d`370e172d : 00000000`00000000 00000000`00000002 ffffbd00`51e51fb0 ffffbd00`544de900 : IntelHaxm+0xa286
ffffa701`a927e760 fffff80d`370e1adf : ffffbd00`51728ef0 00000000`00000000 00000000`00000001 ffffbd00`5192e800 : IntelHaxm+0x172d
ffffa701`a927e7f0 fffff801`a1cdf280 : ffffbd00`51728ef0 ffffa701`a927eb80 00000000`00000001 ffffbd00`00000000 : IntelHaxm+0x1adf
ffffa701`a927e820 fffff801`a1cde164 : ffffbd00`00000000 ffffbd00`51728e04 00000000`00000000 ffffa701`a927eb80 : nt!IopSynchronousServiceTail+0x1a0
ffffa701`a927e8e0 fffff801`a1cddae6 : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : nt!IopXxxControlFile+0x674
ffffa701`a927ea20 fffff801`a19cef93 : 00000000`0000009c 00000000`00000000 00000000`00000000 00000000`00000000 : nt!NtDeviceIoControlFile+0x56
ffffa701`a927ea90 00007ffb`7c534f34 : 00007ffb`7972ca53 00000000`00000000 00000000`00000000 00000000`00000000 : nt!KiSystemServiceCopyEnd+0x13
00000042`95aff4b8 00007ffb`7972ca53 : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : ntdll!NtDeviceIoControlFile+0x14
00000042`95aff4c0 00007ffb`7a5966c0 : 00000000`40002430 00000000`0000009c 00000000`00000003 00000042`00000000 : KERNELBASE!DeviceIoControl+0x73
00000042`95aff530 00007ff6`a6dc16d4 : 00000000`0000009c 00000000`00000000 00000000`00000000 00000000`00000000 : KERNEL32!DeviceIoControlImplementation+0x80
00000042`95aff580 00000000`0000009c : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : TestDrivers!test_bug_hax_vm_vcpu+0xb4
00000042`95aff588 00000000`00000000 : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : 0x9c

MODULE_NAME: memory_corruption

IMAGE_NAME:  memory_corruption

FOLLOWUP_NAME:  memory_corruption

MEMORY_CORRUPTOR:  LARGE

FAILURE_BUCKET_ID:  MEMORY_CORRUPTION_LARGE

BUCKET_ID:  MEMORY_CORRUPTION_LARGE

PRIMARY_PROBLEM_CLASS:  MEMORY_CORRUPTION_LARGE

TARGET_TIME:  2016-10-14T09:31:07.000Z

OSBUILD:  14393

OSSERVICEPACK:  0

SERVICEPACK_NUMBER: 0

OS_REVISION: 0

SUITE_MASK:  272

PRODUCT_TYPE:  1

OSPLATFORM_TYPE:  x64

OSNAME:  Windows 10

OSEDITION:  Windows 10 WinNt TerminalServer SingleUserTS

OS_LOCALE:

USER_LCID:  0

OSBUILD_TIMESTAMP:  2016-10-05 06:17:53

BUILDDATESTAMP_STR:  161004-2338

BUILDLAB_STR:  rs1_release_inmarket

BUILDOSVER_STR:  10.0.14393.321.amd64fre.rs1_release_inmarket.161004-2338

ANALYSIS_SESSION_ELAPSED_TIME: 4d6c

ANALYSIS_SOURCE:  KM

FAILURE_ID_HASH_STRING:  km:memory_corruption_large

FAILURE_ID_HASH:  {e29154ac-69a4-0eb8-172a-a860f73c0a3c}

Followup:     memory_corruption
---------

1: kd>
```
