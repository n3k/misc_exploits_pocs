// TestFltCommunicationPort.cpp : Defines the entry point for the console application.
//

#include "stdafx.h"
#include <Windows.h>

typedef HRESULT (* _FilterConnectCommunicationPort)(
    IN LPCWSTR lpPortName,
    IN DWORD dwOptions,
    IN LPCVOID lpContext,
	IN WORD dwSizeOfContext,
    IN LPSECURITY_ATTRIBUTES lpSecurityAttributes,
	OUT HANDLE hPort
    );

_FilterConnectCommunicationPort FilterConnectCommuicationPort = NULL;

int _tmain(int argc, _TCHAR* argv[])
{
	HANDLE hFortimon3FilterAbortPort;
	HANDLE hFortimon3FilterQueryPort;
	HANDLE hFortimon3FilterSandBoxScanPort;
	HANDLE hFortimon3FilterScanPort;
	HANDLE hFortiShieldPort;
	HMODULE FltLibBase = LoadLibraryA("FltLib.dll");	
	printf("Library Opened %08x\n", FltLibBase);
	FilterConnectCommuicationPort = (_FilterConnectCommunicationPort) GetProcAddress(FltLibBase, "FilterConnectCommunicationPort");
	printf("FilterConnectCommuicationPort Resolved at %08x\n", FilterConnectCommuicationPort);
	FilterConnectCommuicationPort(L"\\Fortimon3FilterAbortPort", 0, NULL, 0, NULL, &hFortimon3FilterAbortPort);
	printf("Fortimon3FilterAbortPort Handle: %08x\n", hFortimon3FilterAbortPort);

	FilterConnectCommuicationPort(L"\\Fortimon3FilterQueryPort", 0, NULL, 0, NULL, &hFortimon3FilterQueryPort);
	printf("Fortimon3FilterQueryPort Handle: %08x\n", hFortimon3FilterQueryPort);

	FilterConnectCommuicationPort(L"\\Fortimon3FilterSandBoxScanPort", 0, NULL, 0, NULL, &hFortimon3FilterSandBoxScanPort);
	printf("Fortimon3FilterSandBoxScanPort Handle: %08x\n", hFortimon3FilterSandBoxScanPort);

	FilterConnectCommuicationPort(L"\\Fortimon3FilterScanPort", 0, NULL, 0, NULL, &hFortimon3FilterScanPort);
	printf("Fortimon3FilterScanPort Handle: %08x\n", hFortimon3FilterScanPort);

	FilterConnectCommuicationPort(L"\\FortiShieldPort", 0, NULL, 0, NULL, &hFortiShieldPort);
	printf("FortiShieldPort Handle: %08x\n", hFortiShieldPort);
	getchar();
	return 0;
}